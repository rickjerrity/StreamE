<!DOCTYPE html>
<html>
<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-162125265-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-162125265-1');
    </script>

    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>StreamE</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel="icon" href="./assets/favicon.ico" type="image/x-icon" />
    <link href="https://fonts.googleapis.com/css?family=Sen&display=swap" rel="stylesheet">
    <link rel='stylesheet' type='text/css' media='screen' href='./styles/main.css'>
    <link rel='stylesheet' type='text/css' media='screen' href='./styles/shadow-inset.css'>
    <script src='./scripts/streamE.js'></script>
    <script src='./scripts/lz-string.min.js'></script>
</head>
<body>
    <div id="container">
        <div class="navbar">
            <div>
                <div onclick="resetPage()"><img src="./assets/streame.png"></div>
            </div>
        </div>
        <div class="search">
            <div id="openCloseFollowing" class="openClose" onclick="toggleViews(true)">
                <ion-icon id="closeFollowingArrow" name="arrow-back-circle-outline" size="large"></ion-icon>
                <ion-icon id="openFollowingArrow" name="arrow-forward-circle-outline" size="large" style="display: none"></ion-icon>
            </div>
            <div id="searchContainer">
                <div class="searchBox">
                    <input type="search" id="searchbox" onkeyup="debouncedSearch()">
                    <span id="clearSearch" onclick="externalClearSearchResults()">x</span>
                </div>
                <div class="searchBox">
                    <div id="searchResults" style="display: none"></div>
                </div>
            </div>
            <div id="openCloseChat" class="openClose" onclick="toggleViews(false, true)">
                <ion-icon id="openChatBox" name="chatbox-ellipses-outline" size="large"></ion-icon>
                <ion-icon id="closeChatBox" name="chatbox-outline" size="large" style="display: none"></ion-icon>
            </div>
        </div>
        <div class="following" id="following">
            <div id="followingList"></div>
            <div class="clearContainer">
                <button class="clearButton" onclick="clearFollowingHash()">Clear<ion-icon name="trash-outline"></ion-icon></button>
            </div>
        </div>
        <div class="chat" id="chat">
            <span id="youtubeChatWarning">YouTube does not support embedding live chat into websites. Chat will open in a new window.</span>
            <iframe id="chat_embed"
                    src=""
                    height="100%"
                    width="100%">
            </iframe>
        </div>
        <div class="titleContent" id="titleContent">
            <h2 id="titleContentHeader"></h2>
        </div>
        <div class="subTitleContent" id="subTitleContent">
            <h4 id="subTitleContentHeader"></h4>
        </div>
        <div class="mainContent shadow-inset-center" id="mainContent">
            <div id="textContent">
                <p>
                    StreamE is an easy way to watch your favorite live streamers across streaming platforms like Twitch, Mixer and YouTube.
                    Use the search bar at the top of the page to search for streamers you like, click the plus sign next to their name to follow them for watching later, and click their name to pull up their channel.
                </p>
                <h3>Frequently Asked Questions</h3>
                <ul>
                    <li><h4>What are the plus (+) and minus (-) signs next to a streamer's name when searching and on the left side bar?</h4>
                        <ul>
                            <li>
                                The plus (+) sign adds a streamer to your following list, which is the left side bar. The minus (-) sign removes a streamer for your following list.
                            </li>
                        </ul>
                    </li>
                    <li><h4>What is my following list?</h4>
                        <ul>
                            <li>
                                The left side bar on the page (or below the search box on mobile view) is your following list. This is the list of streamers you're following on StreamE and is stored in your browser privately.
                                Your following list also appears in the URL encoded as a hash after the pound (#) sign. These URLs/hashes are shareable with friends and other people, for easy sharing of entire following lists of streamers.
                                Please note, this following list has no effect or relation to your personal account followings on Twitch, Mixer, or YouTube.
                            </li>
                        </ul>
                    </li>
                    <li><h4>What is the nasty, long string in the URL?</h4>
                        <ul>
                            <li>
                                As mentioned in the above question, that is your personal list of streamers you're following encoded as a hash. You can bookmark/save the URL/hash for easy access later from another PC, or for sharing your
                                list of favorite streamers with your friends.
                            </li>
                        </ul>
                    </li>
                    <li><h4>YouTube search results/online indicator is not working. What's wrong?</h4>
                        <ul>
                            <li>
                                YouTube, unfortunately, has a rather low API rate-limit per day and we're subject to hit that rate-limit at times depending on site traffic. YouTube does take requests for increases in rate limits, and we do plan to
                                apply for an increase if we continue to hit their API rate limit often.
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
            <div id="videoContent"></div>
        </div>
        <div class="footer">
            <div class="footerContent">
                <h4>StreamE.tv &copy; <span id="copyDate">2020</span> - <a href="https://twitter.com/rickjerrity" target="_blank">@rickjerrity</a></h4>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/ionicons@5.0.0/dist/ionicons.js"></script>
</body>
<script src= "https://player.twitch.tv/js/embed/v1.js"></script>
<script>
    var debouncedSearch = debounce(search, 350);
    var searchResults = [];
    var following = defaultFollowing;
    var watchingStreamer;

    var followingOpen = true;
    var chatOpen = false;

    var liveIndicatorDot = "<span class='liveIndicatorDot'></span>";
    var followWatchingStreamer = '<ion-icon id="followerStreamer" name="add-outline" class="followBtn" onclick="followStreamer(watchingStreamer)"></ion-icon>';

    function addSearchResult(searchResult, index) {
        var newSearchResult = "<div id='" + index + "' class='searchResult' onclick='watchSearchResult(" + index + ")'>";

        if (searchResult.twitch) {
            newSearchResult += "<img src='./assets/TwitchGlitchPurple.svg' class='platformImg'>";
        }
        else if (searchResult.mixer) {
            newSearchResult += "<img src='./assets/MixerMerge_Dark.svg' class='platformImg'>";
        }
        if (searchResult.youtube) {
            newSearchResult += "<img src='./assets/youtube_social_circle_white.png' class='platformImg'>";
        }

        if (searchResult.logo) {
            newSearchResult += "<img src='" + searchResult.logo + "' class='searchResultImg'>";
        }

        newSearchResult += "<span>" + searchResult.username + "</span>";

        var streamerFollowed = false;
        following.forEach((followed) => {
            if (followed.username === searchResult.username) {
                streamerFollowed = true;
            }
        });

        if (!streamerFollowed) {
            newSearchResult += '<ion-icon name="add-outline" class="followBtn" onclick="followSearchResult(' + index + ')"></ion-icon>';
        }

        newSearchResult += "</div>";

        document.getElementById('searchResults').innerHTML += newSearchResult;
    }

    function toggleViews(toggleFollowingList, toggleChat) {
        let previousChatOpen = chatOpen;

        if (toggleFollowingList) {
            followingOpen = !followingOpen;
        }
        if (toggleChat) {
            chatOpen = !chatOpen;
        }

        if (chatOpen && previousChatOpen !== chatOpen) {
            if (watchingStreamer && watchingStreamer.username) {
                loadChatForStreamer(watchingStreamer);
            }
        }
        else if (!chatOpen) {
            document.getElementById('chat_embed').src = "";
            document.getElementById('youtubeChatWarning').style.display = "none";
        }

        var followingView = followingOpen ? 'following ' : '';
        var chatView = chatOpen ? ' chat' : '';

        var newContainer = '';

        newContainer += '"' + (followingOpen ? 'navbar ' : '') + 'navbar' + (chatOpen ? ' navbar' : '') + '"';
        newContainer += '"' + followingView + 'search' + chatView + '"';
        newContainer += '"' + followingView + 'titleContent' + chatView + '"';
        newContainer += '"' + followingView + 'mainContent' + chatView + '"';
        newContainer += '"' + followingView + 'subTitleContent' + chatView + '"';
        newContainer += '"' + (followingOpen ? 'footer ' : '') + 'footer' + (chatOpen ? ' footer' : '') + '"';

        document.getElementById('container').style.gridTemplateAreas = newContainer;

        var firstColumn = followingOpen ? "200px " : "";
        var secondColumn = followingOpen && chatOpen ? "8.5fr" : followingOpen ? "auto" : chatOpen ? "8.5fr" : "auto";
        var thirdColumn = chatOpen ? " 1.5fr" : "";

        document.getElementById('container').style.gridTemplateColumns =  firstColumn + secondColumn + thirdColumn;

        document.getElementById('following').style.display = followingOpen ? "block" : "none";
        document.getElementById('chat').style.display = chatOpen ? "block" : "none";

        document.getElementById('openFollowingArrow').style.display = followingOpen ? 'none' : 'block';
        document.getElementById('closeFollowingArrow').style.display = followingOpen ? 'block' : 'none';

        document.getElementById('openChatBox').style.display = chatOpen ? 'none' : 'block';
        document.getElementById('closeChatBox').style.display = chatOpen ? 'block' : 'none';

        var centerMarginLeft = followingOpen ? "-200px" : "0px";
        var centerMarginRight = chatOpen ? "-18%" : "0px";

        document.getElementById('searchContainer').style.marginLeft = centerMarginLeft;
        document.getElementById('searchContainer').style.marginRight = centerMarginRight;
        document.getElementById('titleContent').style.marginLeft = centerMarginLeft;
        document.getElementById('titleContent').style.marginRight = centerMarginRight;
        document.getElementById('subTitleContent').style.marginLeft = centerMarginLeft;
        document.getElementById('subTitleContent').style.marginRight = centerMarginRight;
    }

    function addFollowed(following, index) {
        var uniqueStreamerId = getUniqueStreamerId(following);

        var newFollow = "<div class='followingContainer' id='" + uniqueStreamerId + "_container" + "'>";
        newFollow += "<div class='inlineContainer'>";
        newFollow += "<div id='" + uniqueStreamerId + "' class='followingUser' onclick='watchFollowing(\"" + following.username + "\")'>";

        if (following.twitch) {
            newFollow += "<img src='./assets/TwitchGlitchPurple.svg' class='platformImg'>";
        }
        if (following.mixer) {
            newFollow += "<img src='./assets/MixerMerge_Dark.svg' class='platformImg'>";
        }
        if (following.youtube) {
            newFollow += "<img src='./assets/youtube_social_circle_white.png' class='platformImg'>";
        }

        newFollow += "<span>" + following.username + "</span>";
        newFollow += "</div>";
        newFollow += '<ion-icon name="remove-circle-outline" class="stopFollowing" onclick="stopFollowingStreamer(\'' + following.username + '\')"></ion-icon>';
        newFollow += '</div>';
        newFollow += "</div>";

        document.getElementById('followingList').innerHTML += newFollow;
    }

    function followSearchResult(index) {
        if (event.stopPropagation) { event.stopPropagation(); }

        followStreamer(searchResults[index]);
    }

    function followStreamer(streamer) {
        var uniqueStreamerId = getUniqueStreamerId(streamer);

        following.push(streamer);

        updateFollowingHash();

        addFollowed(streamer, following.length - 1);

        if (watchingStreamer && getUniqueStreamerId(watchingStreamer) === uniqueStreamerId) {
            document.getElementById('followerStreamer').remove();

            if (watchingStreamer.live) {
                document.getElementById(uniqueStreamerId).innerHTML += liveIndicatorDot;
            }
        }
        else if (ENABLE_ONLINE_CALLS) {
            followingOnline([streamer])
                .then((res) => {
                    if (res && res.length === 1) {
                        var streamerOnlineResult = res[0];

                        if (streamerOnlineResult.live) {
                            document.getElementById(uniqueStreamerId).innerHTML += liveIndicatorDot;
                        }
                    }
                });
        }
    }

    function stopFollowingStreamer(streamerUsername) {
        following.some((followed, index) => {
            if (followed.username === streamerUsername) {
                var uniqueStreamerId = getUniqueStreamerId(followed);

                document.getElementById(uniqueStreamerId + '_container').remove();

                if (watchingStreamer && getUniqueStreamerId(watchingStreamer) === uniqueStreamerId) {
                    document.getElementById('titleContentHeader').innerHTML = followWatchingStreamer + document.getElementById('titleContentHeader').innerHTML;
                }

                following.splice(index, 1);

                updateFollowingHash();

                return true;
            }
        });
    }

    function updateFollowingHash() {
        var followingHashList = [];

        following.forEach((followed) => {
            var followObj = {
                username: followed.username
            };

            if (followed.twitch) {
                followObj.twitch = true;
            }
            else if (followed.mixer) {
                followObj.mixer = true;
            }
            else if (followed.youtube) {
                followObj.youtube = true;
                followObj.channelId = followed.channelId;
            }

            followingHashList.push(followObj);
        });

        var followingHash = LZString.compressToBase64(JSON.stringify(followingHashList));

        localStorage.setItem('following', followingHash);
        window.location.hash = followingHash;
    }

    function checkFollowingOnline() {
        if (ENABLE_ONLINE_CALLS) {
            followingOnline(following)
                .then((res) => {
                    if (res && res.length > 0) {
                        following = res;

                        res.forEach((followed) => {
                            if (followed.live) {
                                var uniqueStreamerId = getUniqueStreamerId(followed);

                                document.getElementById(uniqueStreamerId).innerHTML += liveIndicatorDot;
                            }
                        });
                    }
                });
        }
    }

    function watchFollowing(streamerUsername) {
        following.some((followed) => {
            if (followed.username === streamerUsername) {
                watchStreamer(followed);

                return true;
            }
        });
    }

    function watchSearchResult(index) {
        var streamer = searchResults[index];

        following.forEach((followed) => {
            if (followed.username === streamer.username) {
                streamer = followed;
            }
        });

        watchStreamer(streamer);
        clearSearchResults();
        document.getElementById('searchbox').value = "";
    }

    function loadChatForStreamer(streamer) {
        if (streamer && streamer.username) {
            if (streamer.twitch) {
                document.getElementById('chat_embed').src = "https://www.twitch.tv/embed/" + streamer.username + "/chat?darkpopout&parent=" + window.location.hostname;
                document.getElementById('youtubeChatWarning').style.display = "none";
            }
            else if (streamer.mixer) {
                document.getElementById('chat_embed').src = "https://mixer.com/embed/chat/" + streamer.username;
                document.getElementById('youtubeChatWarning').style.display = "none";
            }
            else if (streamer.youtube) {
                if (streamer.videoId) {
                    document.getElementById('chat_embed').src = "";
                    document.getElementById('youtubeChatWarning').style.display = "block";

                    window.open('https://www.youtube.com/live_chat?v=' + streamer.videoId);
                }
            }
        }
    }

    function watchStreamer(streamer) {
        var videoContent = "";
        var streamerLink = '<a target="_blank" href="';
        var endOfStreamerLink = streamer.username + '">' + streamer.username + '</a>';

        clearVideo();

        document.getElementById('textContent').style.display = 'none';

        watchingStreamer = streamer;

        if (streamer.mixer) {
            videoContent += '<iframe width="100%" height="100%" src="https://mixer.com/embed/player/' + streamer.username + '"></iframe><br />';
            streamerLink += mixerLinkRootUrl + endOfStreamerLink;

            document.getElementById('videoContent').innerHTML = videoContent;
        }
        else if (streamer.twitch) {
            var twitchOptions = {
                width: '100%',
                height: '100%',
                channel: streamer.username,
                layout: 'video-with-chat'
            };
            streamerLink += twitchLinkRootUrl + endOfStreamerLink;

            new Twitch.Player('videoContent', twitchOptions);
        }
        else if (streamer.youtube) {
            videoContent = '<iframe width="100%" height="100%" src="https://www.youtube.com/embed/live_stream?channel=' + streamer.channelId  + '&autoplay=1"></iframe>';
            streamerLink += youtubeLinkRootUrl + streamer.channelId + '">' + streamer.username + '</a>';

            document.getElementById('videoContent').innerHTML = videoContent;
        }

        if (chatOpen) {
            loadChatForStreamer(streamer);
        }

        var followButton = followWatchingStreamer;

        following.forEach((followed) => {
            if (followed.username === streamer.username) {
                followButton = "";
            }
        });

        let streamTitle = streamer.title ? streamer.title : "";
        let category = streamer.category ? streamer.category : "";

        let subTitle = streamTitle;
        if (category !== "") {
            subTitle += " - " + category;
        }

        if (streamer.live !== null && streamer.live !== undefined) {
            var liveIndicator = streamer.live ? liveIndicatorDot : "";

            document.getElementById('titleContentHeader').innerHTML = followButton + streamerLink + liveIndicator;
            document.getElementById('subTitleContentHeader').innerText = subTitle;
        }
        else {
            document.getElementById('titleContentHeader').innerHTML = followButton + streamerLink;
            document.getElementById('subTitleContentHeader').innerText = subTitle;

            if (ENABLE_ONLINE_CALLS) {
                followingOnline([streamer])
                    .then((res) => {
                        if (res && res.length === 1) {
                            watchingStreamer = res[0];
                            var liveIndicator = watchingStreamer.live ? liveIndicatorDot : "";

                            let streamTitle = watchingStreamer.title ? watchingStreamer.title : "";
                            let category = watchingStreamer.category ? watchingStreamer.category : "";

                            let subTitle = streamTitle;
                            if (category !== "") {
                                subTitle += " - " + category;
                            }

                            document.getElementById('titleContentHeader').innerHTML = followButton + streamerLink + liveIndicator;
                            document.getElementById('subTitleContentHeader').innerText = subTitle;
                        }
                    });
            }
        }
    }

    function externalClearSearchResults() {
        document.getElementById('searchbox').value = "";
        clearSearchResults();
    }

    function clearSearchResults() {
        searchResults = [];
        document.getElementById('searchResults').innerHTML = "";
        document.getElementById('searchResults').style.display = 'none';
    }

    function search() {
        var query = document.getElementById('searchbox').value;

        if (query && query.length >= 3) {
            document.getElementById('searchResults').style.display = 'block';
            document.getElementById('searchResults').innerHTML = "";

            if (ENABLE_SEARCH_CALLS) {
                streamerSearch(query)
                    .then((results) => {
                        searchResults = results;

                        searchResults.forEach((result, idx) => {
                            addSearchResult(result, idx);
                        });
                    });
            }
        }
        else {
            clearSearchResults();
        }
    }

    function clearVideo() {
        watchingStreamer = null;
        document.getElementById('videoContent').innerHTML = '';
        document.getElementById('titleContentHeader').innerText = '';
        document.getElementById('subTitleContentHeader').innerText = '';
    }

    function resetPage() {
        var mainContent = document.getElementById('mainContent');

        mainContent.classList = "mainContent";
        mainContent.offsetWidth; // trick to allow CSS animation to be re-triggered (https://css-tricks.com/restart-css-animation/)
        mainContent.classList = "mainContent shadow-inset-center";

        clearVideo();

        document.getElementById('textContent').style.display = 'block';

        var liveIndicators = document.getElementsByClassName('liveIndicatorDot');
        while (liveIndicators[0]) {
            liveIndicators[0].parentNode.removeChild(liveIndicators[0]);
        }

        clearSearchResults();
        fillFollowingList();
        checkFollowingOnline();
    }

    function getFollowingHash() {
        if (window.location.hash) {
            var followingHashArr;

            try {
                followingHashArr = JSON.parse(LZString.decompressFromBase64(window.location.hash.substring(1)));
            }
            catch (ex) {
                console.log(ex);
            }

            if (followingHashArr && followingHashArr.length > 0) {
                following = followingHashArr;
                updateFollowingHash();
            }
        }
        else if (window.localStorage.getItem('following')) {
            var followingHash = window.localStorage.getItem('following');
            var followingHashArr;

            try {
                followingHashArr = JSON.parse(LZString.decompressFromBase64(followingHash));
            }
            catch (ex) {
                console.log(ex);
            }

            if (followingHashArr && followingHashArr.length > 0) {
                following = followingHashArr;
                window.location.hash = followingHash;
            }
        }
    }

    function fillFollowingList() {
        document.getElementById('followingList').innerHTML = "";

        following.forEach((follower, index) => {
            addFollowed(follower, index);
        });
    }

    function clearFollowingHash() {
        document.getElementById('followingList').innerHTML = "";
        window.localStorage.removeItem('following');
        window.location.hash = "";
        following = [];

        if (watchingStreamer) {
            document.getElementById('titleContent').innerHTML = followWatchingStreamer + document.getElementById('titleContent').innerHTML;
        }
    }

    function onPageLoad() {
        getFollowingHash();

        document.getElementById('searchbox')
            .addEventListener('search', () => {
                clearSearchResults();
            });

        fillFollowingList();

        checkFollowingOnline();

        document.getElementById('copyDate').innerText = new Date().getFullYear();
    }

    window.onload = onPageLoad;
</script>
</html>
